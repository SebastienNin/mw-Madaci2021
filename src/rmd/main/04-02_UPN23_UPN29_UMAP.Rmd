---
output: html_document
editor_options: 
  chunk_output_type: console
---

### Hashed samples UPN23 and UPN29

```{r}
Idents(Seurat_UPN23_UPN29_cellhashing) <- Seurat_UPN23_UPN29_cellhashing$MULTI_ID
Seurat_UPN23_UPN29_cellhashing_norm <- subset(Seurat_UPN23_UPN29_cellhashing, 
                                              idents = c("UPN23-cellhashing", "UPN29-cellhashing"))
Seurat_UPN23_UPN29_cellhashing_norm <- normalize_seurat_object(Seurat_UPN23_UPN29_cellhashing_norm)
Seurat_UPN23_UPN29_cellhashing_norm <- perform_clustering_seurat(Seurat_UPN23_UPN29_cellhashing_norm)
DimPlot(Seurat_UPN23_UPN29_cellhashing_norm) + ggtitle("UMAP of UPN23 and UPN29 cell hashing colored by cluster")
DimPlot(Seurat_UPN23_UPN29_cellhashing_norm, group.by = "MULTI_ID") + ggtitle("UMAP of UPN23 and UPN29 cell hashing colored by samples")
```

### UPN23 and UPN29 samples

```{r}
# Perform on non normalized data
UPN23_UPN29_samples <- c(1,2,3,4)
# Seurat_object_list_clustered[UPN23_UPN29_samples]

Seurat_UPN23_filtered_processed <- Seurat_object_list_clustered[[1]]
Seurat_UPN29_filtered_processed <- Seurat_object_list_clustered [[2]]
Seurat_UPN23_UPN29_cellhashing_UPN23_filtered_processed <- Seurat_object_list_clustered[[3]]
Seurat_UPN23_UPN29_cellhashing_UPN29_filtered_processed <- Seurat_object_list_clustered[[4]]

p1 <- DimPlot(Seurat_UPN23_filtered_processed) + ggtitle("Non hashed UPN23")
p2 <- DimPlot(Seurat_UPN29_filtered_processed) + ggtitle("Non hashed UPN29")
p3 <- DimPlot(Seurat_UPN23_UPN29_cellhashing_UPN23_filtered_processed) + ggtitle("Hashed UPN23")
p4 <- DimPlot(Seurat_UPN23_UPN29_cellhashing_UPN29_filtered_processed) + ggtitle("Hashed UPN29")

p1
p2
p3
p4

grid.arrange(p1,p2,p3,p4)

# features <- SelectIntegrationFeatures(object.list = Seurat_object_list_clustered[UPN23_UPN29_samples])
# immune.anchors <- FindIntegrationAnchors(object.list = Seurat_object_list_clustered[UPN23_UPN29_samples], anchor.features = features)
# # this command creates an 'integrated' data assay
# immune.combined <- IntegrateData(anchorset = immune.anchors)
# 
# DefaultAssay(immune.combined) <- "integrated"
# 
# # Run the standard workflow for visualization and clustering
# immune.combined <- ScaleData(immune.combined, verbose = FALSE)
# immune.combined <- RunPCA(immune.combined, npcs = 30, verbose = FALSE)
# immune.combined <- RunUMAP(immune.combined, reduction = "pca", dims = 1:30)
# immune.combined <- FindNeighbors(immune.combined, reduction = "pca", dims = 1:30)
# immune.combined <- FindClusters(immune.combined, resolution = 0.5)
```

### Top 10 marker genes by cluster and samples

#### UPN 23 non cell hashing

```{r}
top_10_heatmap <- draw_top_10_heatmap(seurat_obj = Seurat_UPN23_filtered_processed, DE_table = DE_results_list[[1]])
print(top_10_heatmap)
```

#### UPN 29 non cell hashing

```{r}
top_10_heatmap <- draw_top_10_heatmap(seurat_obj = Seurat_UPN29_filtered_processed, DE_table = DE_results_list[[2]])
print(top_10_heatmap)
```

#### UPN 23 cell hashing

```{r}
top_10_heatmap <- draw_top_10_heatmap(seurat_obj = Seurat_UPN23_UPN29_cellhashing_UPN23_filtered_processed, 
                                      DE_table = DE_results_list[[3]])
print(top_10_heatmap)
```

#### UPN 29 cell hashing

```{r}
top_10_heatmap <- draw_top_10_heatmap(seurat_obj = Seurat_UPN23_UPN29_cellhashing_UPN29_filtered_processed,
                                      DE_table = DE_results_list[[4]])
print(top_10_heatmap)
```

```{r}
# FeaturePlot(Seurat_UPN23_filtered_processed, features = (c("PGP", "ABCC1", "GSTK1", "BCL2", "CLIP1", "TGFB1", "LGALS9")))
# 
# res_genes_expressing_cells <- colnames(GetAssayData(Seurat_UPN23_filtered_processed, slot = "data")[,colSums(GetAssayData(Seurat_UPN23_filtered_processed, slot = "data")[c("PGP", "ABCC1", "GSTK1", "BCL2", "CLIP1", "TGFB1", "LGALS9", "CD34", "IL2RA"),])>1])
# DimPlot(Seurat_UPN23_filtered_processed)
# DimPlot(Seurat_UPN23_filtered_processed, cells = res_genes_expressing_cells)
```